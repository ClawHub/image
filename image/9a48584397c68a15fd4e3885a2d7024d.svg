<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="912px" preserveAspectRatio="none" style="width:1895px;height:912px;background:#FFFFFF;" version="1.1" viewBox="0 0 1895 912" width="1895px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="731.8516" style="stroke:#181818;stroke-width:1.0;" width="10" x="76.5" y="91.2969"/><rect fill="#FFFFFF" height="701.7188" style="stroke:#181818;stroke-width:1.0;" width="10" x="267.5" y="112.4297"/><rect fill="#FFFFFF" height="380.125" style="stroke:#181818;stroke-width:1.0;" width="10" x="827.5" y="368.7578"/><rect fill="#FFFFFF" height="87.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="1525" y="632.3516"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1704" y="661.4844"/><rect fill="none" height="600.3203" style="stroke:#000000;stroke-width:1.5;" width="1702.5" x="187" y="185.6953"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="81" x2="81" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="272" x2="272" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="638.5" x2="638.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="832.5" x2="832.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1098.5" x2="1098.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1285.5" x2="1285.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1529.5" x2="1529.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1708.5" x2="1708.5" y1="81.2969" y2="832.1484"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1812.5" x2="1812.5" y1="81.2969" y2="832.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="5" y="77.9951">SpuWriteBusinessApi</text><ellipse cx="81.5" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M81.5,21.5 L81.5,48.5 M68.5,29.5 L94.5,29.5 M81.5,48.5 L68.5,63.5 M81.5,48.5 L94.5,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="5" y="844.1436">SpuWriteBusinessApi</text><ellipse cx="81.5" cy="855.9453" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M81.5,863.9453 L81.5,890.9453 M68.5,871.9453 L94.5,871.9453 M81.5,890.9453 L68.5,905.9453 M81.5,890.9453 L94.5,905.9453 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="151" x="197" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="137" x="204" y="69.9951">SpuUpdateManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="151" x="197" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="137" x="204" y="851.1436">SpuUpdateManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="188" x="544.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="174" x="551.5" y="69.9951">SpuUpdateCheckHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="188" x="544.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="174" x="551.5" y="851.1436">SpuUpdateCheckHandler</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="180" x="742.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="749.5" y="69.9951">GoodsInfoWriteManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="180" x="742.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="749.5" y="851.1436">GoodsInfoWriteManager</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="170" x="1013.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="156" x="1020.5" y="69.9951">GoodsInfoWriteService</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="170" x="1013.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="156" x="1020.5" y="851.1436">GoodsInfoWriteService</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="184" x="1193.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="1200.5" y="69.9951">GoodsStockWriteService</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="184" x="1193.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="1200.5" y="851.1436">GoodsStockWriteService</text><rect fill="#FFA500" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="285" x="1387.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="271" x="1394.5" y="69.9951">GoodsStockResidueCacheWriteService</text><rect fill="#FFA500" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="285" x="1387.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="271" x="1394.5" y="851.1436">GoodsStockResidueCacheWriteService</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="1682.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1689.5" y="69.9951">Redis</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="53" x="1682.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1689.5" y="851.1436">Redis</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="1745.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="1752.5" y="69.9951">TmSpuApiService</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="1745.5" y="831.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="1752.5" y="851.1436">TmSpuApiService</text><rect fill="#FFFFFF" height="731.8516" style="stroke:#181818;stroke-width:1.0;" width="10" x="76.5" y="91.2969"/><rect fill="#FFFFFF" height="701.7188" style="stroke:#181818;stroke-width:1.0;" width="10" x="267.5" y="112.4297"/><rect fill="#FFFFFF" height="380.125" style="stroke:#181818;stroke-width:1.0;" width="10" x="827.5" y="368.7578"/><rect fill="#FFFFFF" height="87.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="1525" y="632.3516"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1704" y="661.4844"/><polygon fill="#181818" points="255.5,108.4297,265.5,112.4297,255.5,116.4297,259.5,112.4297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="86.5" x2="261.5" y1="112.4297" y2="112.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="93.5" y="107.3638">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="106.5" y="107.3638">updateSpuInfo 更新商品</text><polygon fill="#181818" points="626.5,137.5625,636.5,141.5625,626.5,145.5625,630.5,141.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="277.5" x2="632.5" y1="141.5625" y2="141.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="284.5" y="136.4966">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="297.5" y="136.4966">queryAndCheckGoodsInfo 查询并校验商品信息</text><polygon fill="#181818" points="626.5,166.6953,636.5,170.6953,626.5,174.6953,630.5,170.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="277.5" x2="632.5" y1="170.6953" y2="170.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="284.5" y="165.6294">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="297.5" y="165.6294">queryAndCheckGoodsStock 查询并校验商品库存信息</text><path d="M187,185.6953 L251,185.6953 L251,192.8281 L241,202.8281 L187,202.8281 L187,185.6953 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="600.3203" style="stroke:#000000;stroke-width:1.5;" width="1702.5" x="187" y="185.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="202" y="198.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="250" x="266" y="197.9058">[获取redis锁，key GoodsStock:${spuId}]</text><path d="M282,207.8281 L282,232.8281 L654,232.8281 L654,217.8281 L644,207.8281 L282,207.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M644,207.8281 L644,217.8281 L654,217.8281 L644,207.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="351" x="288" y="224.895">商品下架后，才能更新商品，这里加锁的目的是防止并发请求</text><polygon fill="#181818" points="626.5,255.0938,636.5,259.0938,626.5,263.0938,630.5,259.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="277.5" x2="632.5" y1="259.0938" y2="259.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="284.5" y="254.0278">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="297.5" y="254.0278">checkAndGetStockCount 校验库存,并获取锁定库存量</text><path d="M643,272.0938 L643,342.0938 L1075,342.0938 L1075,282.0938 L1065,272.0938 L643,272.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1065,272.0938 L1065,282.0938 L1075,282.0938 L1065,272.0938 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="649" y="289.1606">查询goodsSellLog</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="649" y="304.2935">锁定的库存数= 锁定总数 - 释放总数；</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="649" y="319.4263">更新的商品库存数量必须大于等于锁定的库存数</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="411" x="649" y="334.5591">商品库存设置的值与售卖量相同，库存剩余量为0，请补充库存后再上架</text><polygon fill="#181818" points="815.5,364.7578,825.5,368.7578,815.5,372.7578,819.5,368.7578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="277.5" x2="821.5" y1="368.7578" y2="368.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="284.5" y="363.6919">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="297.5" y="363.6919">updateSpuInfo 更新prado商品及库存</text><polygon fill="#181818" points="1086.5,393.8906,1096.5,397.8906,1086.5,401.8906,1090.5,397.8906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="837.5" x2="1092.5" y1="397.8906" y2="397.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="844.5" y="392.8247">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="857.5" y="392.8247">updateGoodsInfoBySo 修改商品信息</text><polygon fill="#181818" points="1273.5,423.0234,1283.5,427.0234,1273.5,431.0234,1277.5,427.0234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="837.5" x2="1279.5" y1="427.0234" y2="427.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="844.5" y="421.9575">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="857.5" y="421.9575">saveGoodsStock 修改库存信息</text><path d="M842,440.0234 L842,571.0234 L1311,571.0234 L1311,450.0234 L1301,440.0234 L842,440.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1301,440.0234 L1301,450.0234 L1311,450.0234 L1301,440.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="848" y="457.0903">计算数据库中的剩余库存数：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="276" x="848" y="472.2231">1、前端传过来的库存数量为0，代表不限制库存</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132" x="848" y="487.356">1.1、设置剩余数量为0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="328" x="848" y="502.4888">2、如果前端传过来的库存数量不为0，则设置了库存数量</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="392" x="848" y="517.6216">2.1、如果当前库中的库存数为0，则表示以前设置的是不限制库存的</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="868" y="532.7544">剩余数量 = 前端设置的库存数 - 当前锁定的库存数</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="327" x="848" y="547.8872">2.2、如果当前库中的库存数不为0，则以前设置了库存数</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="428" x="868" y="563.02">剩余数量 = 前端设置的库存数 - 当前库中的库存数 + 当前库中的剩余数量</text><path d="M842,581.0859 L842,606.0859 L1358,606.0859 L1358,591.0859 L1348,581.0859 L842,581.0859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1348,581.0859 L1348,591.0859 L1358,591.0859 L1348,581.0859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="495" x="848" y="598.1528">计算Redis中的剩余库存 =数据库中的剩余库存数， 如果不限库存，则剩余库存值为-1</text><polygon fill="#181818" points="1513,628.3516,1523,632.3516,1513,636.3516,1517,632.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="837.5" x2="1519" y1="632.3516" y2="632.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="844.5" y="627.2856">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="857.5" y="627.2856">initStockResidue 初始化库存剩余数</text><polygon fill="#181818" points="1692,657.4844,1702,661.4844,1692,665.4844,1696,661.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1535" x2="1698" y1="661.4844" y2="661.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="1542" y="656.4185">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="1555" y="656.4185">set 剩余库存</text><polygon fill="#181818" points="1546,686.6172,1536,690.6172,1546,694.6172,1542,690.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1540" x2="1708" y1="690.6172" y2="690.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1552" y="685.5513">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="1574" y="685.5513">结果</text><polygon fill="#181818" points="848.5,715.75,838.5,719.75,848.5,723.75,844.5,719.75" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="842.5" x2="1529" y1="719.75" y2="719.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="854.5" y="714.6841">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="876.5" y="714.6841"> </text><polygon fill="#181818" points="288.5,744.8828,278.5,748.8828,288.5,752.8828,284.5,748.8828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="282.5" x2="831.5" y1="748.8828" y2="748.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="294.5" y="743.8169">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="316.5" y="743.8169"> </text><polygon fill="#181818" points="1800.5,774.0156,1810.5,778.0156,1800.5,782.0156,1804.5,778.0156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="277.5" x2="1806.5" y1="778.0156" y2="778.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="284.5" y="772.9497">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="306.5" y="772.9497">updateSpu 修改商品中心商品数据</text><polygon fill="#181818" points="97.5,810.1484,87.5,814.1484,97.5,818.1484,93.5,814.1484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="91.5" x2="271.5" y1="814.1484" y2="814.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="103.5" y="809.0825">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="125.5" y="809.0825"> </text></g></svg>